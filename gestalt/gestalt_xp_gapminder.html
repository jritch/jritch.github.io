<!DOCTYPE html>
<html>
  <head>
    <!-- Load D3 from site -->
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-timer.v1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="./data.js" charset="utf-8"></script>
    <script src="./gapminder.augmented.js" charset="utf-8"></script>
    <script xmlns="http://www.w3.org/1999/xhtml" async="" src="https://cdn.rawgit.com/eligrey/Blob.js/0cef2746414269b16834878a8abc52eb9d53e6bd/Blob.js"></script>
    <script xmlns="http://www.w3.org/1999/xhtml" async="" src="https://cdn.rawgit.com/eligrey/FileSaver.jse9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
  </head>


  <link rel="stylesheet" type="text/css" href="main.css">


  <body id="thebody">

    <div id="container">

      <div id="xpcontainer">
        <h1 id="year">Quality of Life from 1960 to 2014</h1>
        <h3 id="d3plot"> </h3>
      </div>

      <div id="end">
        <div id="span">
          <p> Congratulations! The experiment is over. </p>
          <br /> <br /> <br /> <br />
          <p>Please call the experimenter. </p>
        </div>
      </div>

      <div id="overlay">
        <div id="span">
          <p> Note that you can take a break between trials </p>
          <br /> <br /> <br /> <br />
          <p>Press &lt;Enter&gt; to continue </p>
        </div>
      </div>

    </div>

    

    <div id="controls">
      <input id="replay" type="submit" class="button" value="Replay">
      <br><br>
      <div style="border:1px solid black">
      <p>
        <b> X Position: </b>
        <span id="select-x"></span>
     </p>
      
      <p>
        <b>Y Position: </b>
        <span id="select-y"></span>
      </p>
      
      <p>
        <b>Size: </b>
        <span id="select-s"></span>
      </p>
      
      <p>
        <b>Luminance: </b>
        <span id="select-l"></span>
      </p>
      </div>
      <div id="question">
        
        <div id="q1">
          <h2>What patterns do you see in the visualization?</h2>
          <textarea rows=10 columns=200></textarea>
          <br><br>
        </div>

        <div id="q3">
          <h2>Which dynamic variable(s) create the most visible patterns in the visualization?</h2>
          <div style="border: 1px solid black; text-align: center;">

          <!-- Adapted from: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/radio -->
          <form>
            <h2>Points changing in position</h2>
            <div>
              <input type="radio" id="DPChoice1"
               name="DP" value="1">
              <label for="DPChoice1">Rank 1 (Strongest)</label>

              <input type="radio" id="DPChoice2"
               name="DP" value="2">
              <label for="DPChoice2">Rank 2</label>

              <input type="radio" id="DPChoice3"
               name="DP" value="3">
              <label for="DPChoice3">Rank 3 (Weakest)</label>
              
            </div>
          </form>

          <form>
            <h2>Points changing in size</h2>
            <div>
              <input type="radio" id="DSChoice1"
               name="DS" value="1">
              <label for="DSChoice1">Rank 1 (Strongest)</label>

              <input type="radio" id="DSChoice2"
               name="DS" value="2">
              <label for="DSChoice2">Rank 2</label>

              <input type="radio" id="DSChoice3"
               name="DS" value="3">
              <label for="DSChoice3">Rank 3 (Weakest)</label>              
            </div>
          </form>

          <form>
            <h2>Points changing in brightness</h2>
            <div>
              <input type="radio" id="DLChoice1"
               name="DL" value="1">
              <label for="DLChoice1">Rank 1 (Strongest)</label>

              <input type="radio" id="DLChoice2"
               name="DL" value="2">
              <label for="DLChoice2">Rank 2</label>

              <input type="radio" id="DLChoice3"
               name="DL" value="3">
              <label for="DLChoice3">Rank 3 (Weakest)</label>
              
            </div>
          </form>          
            
            <br></br>
          </div>
          
          <h2>Briefly explain why you chose this ranking.</h2>
          <textarea rows=5 columns=10></textarea>
          <br><br>
        </div>

        <div id="q2">
          <h2>Which country is closest in behaviour to the highlighted country?</h2>
          <h3>ENTER to pause / restart</h3> <h3>CLICK country to select</h3>
          <h2>Briefly explain why you believe it is closest in behaviour.</h2>
          <textarea rows=5 columns=10></textarea>
          <br><br>
        </div>

        <input id="submit_answer" type="submit" class="button" value="Advance">
      </div>

    </div>
  </body>

    

<script type="text/javascript">
        function hide(idelement) {
            document.getElementById(idelement).style.display = "none";
        }

        function show(idelement) {
            document.getElementById(idelement).style.display = "block";
        }

        //https://stackoverflow.com/questions/2332811/capitalize-words-in-string
        String.prototype.capitalize = function() {
            return this.replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
        };

        tasks = [
              [{"y": "life_expectancy", "x": "fertility_rate" , "s": "income"         , "l": "child_mortality"}, "Mali"],
              [{"y": "life_expectancy", "x": "fertility_rate" , "s": "child_mortality", "l": "income"}, "Vietnam"],        
              [{"y": "life_expectancy", "x": "child_mortality", "s": "fertility_rate" , "l": "income"} , "Qatar"],       
              [{"y": "life_expectancy", "x": "income"         , "s": "fertility_rate" , "l": "child_mortality"}, "UnitedArabEmirates"],
              [{"y": "life_expectancy", "x": "income"         , "s": "child_mortality", "l": "fertility_rate"}, "Kazakhstan"],
              [{"y": "life_expectancy", "x": "child_mortality", "s": "income"         , "l": "fertility_rate"}, "Switzerland"]
           ]                      

        // this timer runs in the background, and ensures that the target country
        // for the nearest neighbour task is highlighted in red

        var is_paused = 0

        var highlight_timer = d3.timer(function(){})

        function advance(trial_i, question_i,highlight) {
          

          // only display one question at a time
          question_vars = ["q1","q2","q3"];
          for (i=0;i<3;i++) {
            if (question_i  == i) {
              $("#" + question_vars[i]).attr("style","display:block")
            }
            else {
              $("#" + question_vars[i]).attr("style","display:none") 
            }
          }

          // during development we experimented with showing
          // for the final experiment we show all 6 gapminder regions

          mapping = tasks[trial_i][0]
          regions = ["Sub-Saharan Africa","Europe & Central Asia","East Asia & Pacific", "South Asia","Middle East & North Africa","America"]

          // this var records the user's answer to the nearest neighbour question
          highlighted = highlight;

          // delete and regenerate the svg with the new mapping

          d3.selectAll("svg").remove()
          data_series = generateData(gapminder,mapping)
          showData(data_series)              

          // stop showing the previous target in red
          // show the new target

          highlight_timer.stop()
          if (question_i == 1)
          {
            highlight_timer = d3.timer(()=>d3.selectAll("#" + tasks[trial_i][1]).attr("style","stroke:red; stroke-width:2px"));
          }
          

          // display the mapping to the user
          for (key in tasks[trial_i][0]) {
            $("#select-" + key).html(tasks[trial_i][0][key].replace("_"," ").capitalize())
            
          }            
      
          // De-select the advance button so the user does not automatically hit it 
          // when they pause with ENTER button
          $('input').blur()

        }

        function pause() {
          //global_timer.stop()
          d3.selectAll("circle").transition()
        }

        function regenerate() {
            d3.selectAll("svg").remove()
            data_series = generateData(gapminder,mapping)
            showData(data_series)
        }

        $("#controls > select").on("click",function() {})
        
        d3.select("body").on("keypress", function() {
            if(d3.event.keyCode === 13){
              if (!is_paused){
                is_paused = 1;
                pause();
              }
              else {
                is_paused = 0;
                regenerate()
              }
            }
          });


        hide("end")
        hide("overlay")

        data_series = generateData(gapminder,mapping)
        showData(data_series)
        var trial_i = 0;

        answers = []

        function add_answer() {

            answer = {}
            answer["text"] = $("textarea").val()
            answer["ranks"] = [$("#select-domininant-x").val(), $("#select-domininant-s").val(), $("#select-domininant-l").val() ]
            answer["closest"] = highlighted
            answers.push(answer)
        }

        function advanceButtonHandler () {
          $('input').prop('checked', false);

          // if it's not the last trial
          if (trial_i < 5) {
            add_answer(trial_i,question_i)
            trial_i += 1
            advance(trial_i,question_i,"null")
          }

          else if (trial_i == 5){
            // if it's the last trial for this question
            if (question_i < 2) {
              // go to the next question
              add_answer(trial_i,question_i)
              question_i += 1 
              trial_i = 0
              advance(trial_i,question_i,"null")
            }
            else if (question_i == 2) {
              // or if it's the last question, save the answers
              // and show the end screen
              add_answer(trial_i,question_i)
              show("end")
              pause()
              localStorage["answers"] = JSON.stringify(answers)  
            }
          }
        }




        $("#submit_answer").on("click", function () {
          
          if (true)
          //if (confirm("Are you sure you want to advance?"))
          {
            advanceButtonHandler();
          }      
          
        });

        var question = ""
        question_i = 0 

        advance(0,0,"null")

        $("#replay").on("click", function() {
          advance(trial_i,question_i,highlighted)
        });


  </script>
</html>
