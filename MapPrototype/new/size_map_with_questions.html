<!DOCTYPE html>
<!-- adapted from: https://bl.ocks.org/wboykinm/dbbe50d1023f90d4e241712395c27fb3 -->
<html lang="en">
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="main.css">
<link rel="stylesheet" type="text/css" href="slider.css">

</head>
<body>
<div class="map_container">

<div style="border: 1px solid black; padding-left: 5px">
  <p> <b>Color</b>: <span id="color_text">Change in Voter Turnout From 2012 to 2016 (Purple is decrease)</span> </p>
  <p> <b>Size</b>: <span id="motion_text">Swing (2016 Margin - 2012 Margin). Rightward motion means more Republican.</span> </p>
</div>
<br>
<div class="map">
</div>
<div style="padding-top: 50px">
<!--<p style="text-align: center" id="progress"><b>Progress: 0/4 trials</b></p>-->
</div>
</div>
<div class="controls">

<div id="question">
        <input id="replay" type="submit" value="Replay">

        <div id="q1">
          <h2>What patterns do you see in the visualization?</h2>
          <textarea rows=10 columns=200></textarea>
          <br><br>
        </div>

        <div id="q3">
          <h2>Which dynamic variable(s) create the most visible patterns in the visualization?</h2>
          <div style="border: 1px solid black; text-align: center;">

          <!-- Adapted from: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/radio -->

          <form>
            <h2>Points changing in size</h2>
            <div>
              <input type="radio" id="DSChoice1"
               name="DS" value="1">
              <label for="DSChoice1">Rank 1 (Strongest)</label>

              <input type="radio" id="DSChoice2"
               name="DS" value="2">
              <label for="DSChoice2">Rank 2 (Weakest)</label>     
            </div>
          </form>

          <form>
            <h2>Points changing in brightness</h2>
            <div>
              <input type="radio" id="DLChoice1"
               name="DL" value="1">
              <label for="DLChoice1">Rank 1 (Strongest)</label>

              <input type="radio" id="DLChoice2"
               name="DL" value="2">
              <label for="DLChoice2">Rank 2 (Weakest) </label>
              
            </div>
          </form>          
            
            <br></br>
          </div>
          
          <h2>Briefly explain why you chose this ranking.</h2>
          <textarea rows=5 columns=10></textarea>
          <br><br>
        </div>

        <div id="q2">
          <h2>Which country is closest in behaviour to the highlighted country?</h2>
          <h3>ENTER to pause / restart</h3> <h3>CLICK country to select</h3>
          <h2>Briefly explain why you believe it is closest in behaviour.</h2>
          <textarea rows=5 columns=10></textarea>
          <br><br>
        </div>


    <input id="submit_answer" type="submit" value="Advance">
</div>
<br>


<script type="text/javascript">


//Width and height of map
var width = 800;
var height = 400;

var highlighted = "null";

var highlight_timer = d3.timer(function(){})

var global_timer;

function render_map(center,render_mode,highlight) {

    highlighted = highlight
    
    // only display one question at a time
    question_vars = ["q1","q2","q3"];
    for (i=0;i<3;i++) {
      if (question_i  == i) {
        $("#" + question_vars[i]).attr("style","display:block")
      }
      else {
        $("#" + question_vars[i]).attr("style","display:none") 
      }
    }



    var mode = render_mode;
    d3.selectAll("svg").remove();

    // D3 Projection
    var svg = d3.select(".map")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("display","block")
    //d3.selectAll("circle").remove()

    svg.append("rect")
      .attr("width", width)
      .attr("height", height)
      .attr("fill","rgb(170,218,255)");

    var projection = d3.geoAlbersUsa()
      .translate(center) // translate to center of screen
      .scale([1600]); // scale things down so see entire US

    // Define path generator
    var path = d3.geoPath() // path generator that will convert GeoJSON to SVG paths
      .projection(projection); // tell path generator to use albersUsa projection

    //Create SVG element and append map to the SVG
    
    // Load in my states data
    d3.csv("calculations.csv", function(data) {

      
      function get_ramp(data, varName)  {
        var dataArray = [];

        for (var d = 0; d < data.length; d++) {
            dataArray.push(parseFloat(data[d][varName]))
        }
        var minVal = d3.min(dataArray);
        var maxVal = d3.max(dataArray);
        var absMax= Math.max(Math.abs(minVal),Math.abs(maxVal));
        var ramp = d3.scaleSequential(d3.interpolate(2,25)).domain([-absMax,absMax]);
        return ramp;
      }

      var ramp = get_ramp(data, "turnout_delta");
      var delta_ramp = get_ramp(data, "dem_delta");

      interp_bw = d3.interpolateLab("black","white");

      var g_ramp = d3.scaleSequential(interp_bw).domain([ramp.domain()[0] ,ramp.domain()[1] ]);
      var g_delta_ramp = d3.scaleSequential(interp_bw).domain([delta_ramp.domain()[0],delta_ramp.domain()[1] ]);

      function grayscale_ramp(num) {

          if (num > g_ramp.domain()[1]) {
            return "rgb(255,255,255)";
          }
          else if (num < g_ramp.domain()[0]) {
            return "rgb(0,0,0)";
          }
          else {
            return g_ramp(num);
          }
      }

      function grayscale_delta_ramp(num) {

          if (num > g_delta_ramp.domain()[1]) {
            return "rgb(255,255,255)";
          }
          else if (num < g_delta_ramp.domain()[0]) {
            return "rgb(0,0,0)";
          }
          else {
            return g_delta_ramp(num);
          }
      }

      // Load GeoJSON data and merge with states data
      d3.json("us-states.json", function(json) {

          // load data on the centers
        d3.csv("state_centers.csv", function (centroid_array) {
              

          // Loop through each state data value in the .csv file
          for (var i = 0; i < data.length; i++) {

            // Grab State Name
            var dataState = data[i].state;

            // Grab data value
            var dataValue = data[i].dem_delta;
            var dataFlipped = -1 * data[i].value;
            var dataMargin = data[i]["2016_margin_flip"]
            var dataOldMargin = data[i]["2012_margin"]
            var turnout_delta = data[i]["turnout_delta"]


            // Find the corresponding state inside the GeoJSON
            for (var j = 0; j < json.features.length; j++) {
              var jsonState = json.features[j].properties.name;

              if (dataState == jsonState) {

                // Copy the data value into the JSON
                json.features[j].properties.value = dataValue;
                json.features[j].properties.flipped = dataFlipped;
                json.features[j].properties.margin = dataMargin;
                json.features[j].properties.old_margin = dataOldMargin;
                json.features[j].properties.turnout_delta = turnout_delta;
                json.features[j].properties.state = dataState;

                json.features[j].properties.votes = 8    // make them all a standard size

                // Stop looking through the JSON
                break;
              }
            }
          }

          // Bind the data to the SVG and create one path per GeoJSON feature
          svg.selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("stroke", "black")
            .style("stroke-width", "0.7")
            .attr("fill", function(d) {
                return "rgb(172,218,151)"});
                //return "rgb(119,119,119"});

            
            svg.selectAll("circle").data(json.features).enter().append("circle")
            .attr("cx", function (d,i) {
               return projection([centroid_array[i]["Longitude"],centroid_array[i]["Latitude"]])[0]
              })
            .attr("cy", function (d,i) {
               return projection([centroid_array[i]["Longitude"],centroid_array[i]["Latitude"]])[1]
              })
            .attr("r", function(d) {
               return Math.sqrt(d.properties.votes) * 2 })
            .attr("fill", function(d) {
              return ramp(d.properties.margin);})
            .attr("id", function(d) {
              return d.properties.state.replace(/\s/g, '');})
     

            

            // DC is not a state, and it is occluded by Maryland
            

            function play(mode) {
              
              if (mode == "Mode 1") {

                  function do_circle(elapsed) {
                    is_paused = 0;
                    var circ = d3.selectAll("circle").data(json.features)
                    circ
                    .attr("fill", function(d) {

                        col =  $("#grayscale:checked").val() == "on" ? grayscale_delta_ramp : grayscale_delta_ramp;
                      return col(0);})
                    .attr("r", function(d) {
                      return Math.sqrt(ramp(0)) * 3 })
                    .attr("visibility","hidden")
                    .transition()
                    .duration(250)
                    .transition()
                    .duration(2000)
                    .attr("r", function(d) {
                      return Math.sqrt(ramp(d.properties.turnout_delta)) * 3 })
                    .attr("fill", function(d) {
                     col =  $("#grayscale:checked").val() == "on" ? grayscale_delta_ramp : grayscale_delta_ramp;
                      return col(d.properties.value);})

                      setTimeout(function (){svg.selectAll("circle").attr("visibility","");d3.selectAll("#DistrictofColumbia").attr("visibility","hidden");}, 250)        
                      setTimeout(function (){if (!is_paused) {svg.selectAll("circle").attr("visibility","hidden")}}, 2250)    
                  }


              }
              if (mode == "Mode 2") {

                function do_circle() {
                  is_paused = 0;
                  var circ = d3.selectAll("circle").data(json.features)
                
                  circ
                  .attr("fill", function(d) {

                      col =  $("#grayscale:checked").val() == "on" ? grayscale_ramp : grayscale_ramp;
                      return col(0);})
                  .attr("r", function(d) {
                      return Math.sqrt(delta_ramp(0)) * 3 })
                  .attr("visibility","hidden")
                  .transition()
                  .duration(250)
                  .transition()
                  .duration(2000)
                  .attr("r", function(d) {
                      return Math.sqrt(delta_ramp(d.properties.value)) * 3 })

                  .attr("fill", function(d) {
                   col =  $("#grayscale:checked").val() == "on" ? grayscale_ramp : grayscale_ramp;
                   return col(d.properties.turnout_delta)})
                     
                  setTimeout(function (){svg.selectAll("circle").attr("visibility",""); d3.selectAll("#DistrictofColumbia").attr("visibility","hidden");}, 250)        
                  setTimeout(function (){if (!is_paused) {svg.selectAll("circle").attr("visibility","hidden")}}, 2250)    
                  
                }
              
              }

              

              highlight_timer.stop()
              if (question_i == 2)
              {
                highlight_timer = d3.timer(()=>d3.selectAll("#" + trials[trial_i][2]).attr("style","stroke:red; stroke-width:2px"));
              }
              $("#" + highlighted).addClass("highlight")
              do_circle()
              //global_timer = d3.interval(do_circle, 2700)              
            }
            function change_encoding_text(mode){
                if (mode == "Mode 1") {
                  d3.select("#motion_text").html("Change in Voter Turnout From 2012 to 2016 (Becoming smaller is decrease)")
                  d3.select("#color_text").html("Change in Democratic votes from 2012 to 2016. (Darkening is decrease).")
                }
                else {
                  d3.select("#motion_text").html("Change in Democratic votes from 2012 to 2016. (Becoming smaller is decrease).</span> </p>")
                  d3.select("#color_text").html("Change in Voter Turnout From 2012 to 2016. (Darkening is decrease)")
                }
            }

            function reset(mode) {

                if (global_timer != undefined) {
                    global_timer.stop()
                }


                d3.selectAll("circle")
                .data(json.features)
                .attr("transform", "")
            

                svg.selectAll("circle")
                .data(json.features)
                .attr("fill", function(d) {
                    return grayscale_ramp(0);
                })
                .attr("r", function(d) {
                    return Math.sqrt(delta_ramp(0)) * 3
                })

              
                change_encoding_text(mode)
            }

          reset(mode)

          d3.select("#play")
               .on("mousedown", function() {play(mode)})
                   .on("touchdown", function() {play(mode)})

            d3.select("#reset")
                .on("mousedown", function() {reset(mode)})
                .on("touchdown", function() {reset(mode)})


          reset(mode)
          play(mode)

          $("circle").on("click", function () {
                $("circle").removeClass("highlight")
                $(this).addClass('highlight')
                highlighted = $(this).attr("id")
          })
        });
      });

    });

    $('input').blur()




}

var answers = []


// the map views are chosen arbitrarily
// we try to minimize the overlap as much as possible
// while keeping a reasonable view
var trials = [
        [[width * 1/4,height * 1/5], "Mode 1", "Kentucky"],
        [[width,height * 5/6], "Mode 2","SouthDakota"],
        [[width,height * 1/4], "Mode 2","Iowa"],
        [[width * 1/4,height * 7/8], "Mode 1","WestVirginia"],

]

var trial_i = 0;
var question_i = 0;

question = trials[trial_i]

render_map(question[0],question[1],"null")


$("#submit_answer").click( function () {
    
    if (trial_i < 3) {
        trial_i++ 
        answers.push([$("textarea").val(), $("#select-domininant").val()])
        question = trials[trial_i]
        //$("#progress").html("<b>Progress: "+question_i+"/4 trials</b>")
        render_map(question[0],question[1], "null")
    }
    else if (trial_i == 3) {
        
        if (question_i < 2)
        {
          question_i++
          trial_i = 0
          question = trials[trial_i]
          $("#progress").html("<b>Progress: "+question_i+"/4 trials</b>")
          render_map(question[0],question[1], 'null')
        }
        else if (question_i == 2) {
          answers.push([$("textarea").val(), $("#select-domininant").val()])
          $("body").html("<h1>Experiment Complete</h1>")
      }
        
    }
})

function pause() {
        //global_timer.stop()
        d3.selectAll("circle").transition()
      }

d3.select("body").on("keypress", function() {
    if(d3.event.keyCode === 13){
      if (!is_paused){
        is_paused = 1;
        pause();
      }
      else {
        is_paused = 0;
        render_map(question[0],question[1], highlighted)
      }
    }
  });

$("#replay").on("click", function () {render_map(question[0],question[1],highlighted) })

</script>
</body>
</html>
