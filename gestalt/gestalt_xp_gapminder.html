<!DOCTYPE html>
<html>
  <head>
    <!-- Load D3 from site -->
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-timer.v1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" charset="utf-8"></script>
    <script src="./data.js" charset="utf-8"></script>
    <script src="./gapminder.augmented.js" charset="utf-8"></script>
    <script xmlns="http://www.w3.org/1999/xhtml" async="" src="https://cdn.rawgit.com/eligrey/Blob.js/0cef2746414269b16834878a8abc52eb9d53e6bd/Blob.js"></script>
    <script xmlns="http://www.w3.org/1999/xhtml" async="" src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
  </head>


  <link rel="stylesheet" type="text/css" href="main.css">

  <body id="thebody">

  <div id="container">
    <div id="xpcontainer">
        
        <h1 id="year"> </h3>
        <h3 id="d3plot"> </h3>

    </div> <!-- xpcontainer -->

    <div id="end">
        <div id="span">
            <p> Congratulations! The experiment is over. </p>
            <br /> <br /> <br /> <br />
            <p>Please call the experimenter. </p>
        </div>
    </div>

    <div id="overlay">
        <div id="span">
            <p> Note that you can take a break between trials </p>
            <br /> <br /> <br /> <br />
            <p>Press &lt;Enter&gt; to continue </p>
        </div>
    </div>
    </div>

    <div id="controls">
        <input id="toggle_q" type="button"  value="DEBUG: toggle questions">
        <br></br>
        <input id="toggle_p" type="button"  value="DEBUG: toggle paused">
        <h2>X Position</h1>
        <select id="select-x">
            <option value="fertility_rate">fertility_rate</option>
            <option value="income">income</option>
            <option value="child_mortality">child_mortality</option>
            <!--<option value="co2_emissions">co2_emissions</option>-->
            <option value="population">population</option>
            <option value="life_expectancy" selected="selected">life_expectancy</option>
            <option value="">random</option>
          </select>
          <h2>Y Position</h2>
          <select id="select-y">
            <option value="fertility_rate" selected="selected">fertility_rate</option>
            <option value="income">income</option>
            <option value="child_mortality">child_mortality</option>
            <!--<option value="co2_emissions">co2_emissions</option>-->
            <option value="population">population</option>
            <option value="life_expectancy">life_expectancy</option>
            <option value="">random</option>
          </select>
          <h2>Size</h2>
          <select id="select-s">
            <option value="fertility_rate">fertility_rate</option>
            <option value="income" selected="selected">income</option>
            <option value="child_mortality">child_mortality</option>
            <!--<option value="co2_emissions">co2_emissions</option>-->
            <option value="population">population</option>
            <option value="life_expectancy">life_expectancy</option>
            <option value="">random</option>
          </select>
          <h2>Luminance</h2>
          <select id="select-l">
            <option value="fertility_rate">fertility_rate</option>
            <option value="income">income</option>
            <option value="child_mortality" selected="selected">child_mortality</option>
            <!--<option value="co2_emissions">co2_emissions</option>-->
            <option value="population">population</option>
            <option value="life_expectancy">life_expectancy</option>
            <option value="" >random</option>
          </select>

          <div style="display: none">
            <h2>Start Year</h2>
              <input type="text" id="year_0" value="1960"></input><br>
              <h2>End Year</h2>
              <input type="text" id="year_N" value="2014"></input>
              <br><br>

              <br><br>
              <div style="text-align: left; padding-left: 80px">
              <label><input type="checkbox" checked=true name="checkbox" value="Sub-Saharan Africa">Sub-Saharan Africa</label><br>
              <label><input type="checkbox" checked=true name="checkbox" value="Europe & Central Asia">Europe & Central Asia</label><br>

              <label><input type="checkbox" name="checkbox" value="East Asia & Pacific">East Asia & Pacific</label><br>
              <label><input type="checkbox" name="checkbox" value="Middle East & North Africa">Middle East & North Africa</label><br>

              <label><input type="checkbox" name="checkbox" value="America">America</label><br>
              <label><input type="checkbox" name="checkbox" value="South Asia">South Asia</label><br>
            </div>



          </div>

          <div id="question">
            
            <div id="q1">
              <h2>What clusters do you see in the visualization?</h2>
              <textarea rows=10 columns=200></textarea>
              <br><br>
            </div>

            <div id="q2">

              <h2>Which dynamic variable(s) create the most visible clusters in the visualization?</h2>
              <div style="border: 1px solid black; text-align: center;">
              <h2>Dynamic Position</h2>
              <select id="select-domininant-x">
                <option value="1" selected="selected">Rank 1</option>
                <option value="2">Rank 2</option>
                <option value="3">Rank 3</option>
              </select>
              <h2>Dynamic Size</h2>
               <select id="select-domininant-s">
                <option value="1" selected="selected">Rank 1</option>
                <option value="2">Rank 2</option>
                <option value="3">Rank 3</option>
              </select>
              <h2>Dynamic Luminance</h2>
              <select id="select-domininant-l">
                <option value="1" selected="selected">Rank 1</option>
                <option value="2">Rank 2</option>
                <option value="3">Rank 3</option>
              </select>
              <br></br>
              </div>
              
              <h2>Briefly explain your answer.</h2>
              <textarea rows=5 columns=10></textarea>
              <br><br>
            </div>
            <div id="q3">
              <h2>Which country is closest in behaviour to the highlighted country?</h2>
              <h3>ENTER to pause / restart</h3> <h3>CLICK country to select</h3>
              <h2>Briefly explain your answer.</h2>
              <textarea rows=5 columns=10></textarea>
              <br><br>
            </div>
            <input id="submit_answer" type="submit" class="button" value="Advance">
          </div>


    </div>

    

    <script type="text/javascript">
        function hide(idelement) {
            document.getElementById(idelement).style.display = "none";
        }
        function show(idelement) {
            document.getElementById(idelement).style.display = "block";
        }

        function update_mapping(e) {
            console.log(e)
            mapping[e.target.id.replace("select-","")] = e.target.value;
            d3.selectAll("svg").remove()
            data_series = generateData(gapminder,mapping)
            showData(data_series)
        }

        tasks = [
              [{"y": "life_expectancy", "x": "fertility_rate" , "s": "income"         , "l": "child_mortality"}, ["Sub-Saharan Africa", "Europe & Central Asia"], "Turkey"],
              [{"y": "life_expectancy", "x": "fertility_rate" , "s": "child_mortality", "l": "income"}         , ["East Asia & Pacific", "America"], "Vietnam"],        
              [{"y": "life_expectancy", "x": "child_mortality", "s": "fertility_rate" , "l": "income"}         , ["South Asia", "America"], "India"],       
              [{"y": "life_expectancy", "x": "income"         , "s": "fertility_rate" , "l": "child_mortality"}, ["Middle East & North Africa","Europe & Central Asia"], "Oman"],
              [{"y": "life_expectancy", "x": "income"         , "s": "child_mortality", "l": "fertility_rate"} , ["East Asia & Pacific", "South Asia"], "China"],
              [{"y": "life_expectancy", "x": "child_mortality", "s": "income"         , "l": "fertility_rate"} , ["East Asia & Pacific","Sub-Saharan Africa"], "Japan"]
           ]                      

        var advance_timer = d3.timer(function(){})


        function advance(i) {
          d3.selectAll("svg").remove()
          highlighted = "null"

          mapping = tasks[i][0]
          regions = ["Sub-Saharan Africa","Europe & Central Asia","East Asia & Pacific", "South Asia","Middle East & North Africa","America"]

          data_series = generateData(gapminder,mapping)
          showData(data_series)
          
          advance_timer.stop()
          advance_timer = d3.timer(()=>d3.selectAll("#" + tasks[i][2]).attr("style","stroke:red; stroke-width:2px"));


          for (key in tasks[i][0]) {
            $("#select-" + key).val(tasks[i][0][key])
            
          }
            

          $("input[type=checkbox]").each( function(key,value) {if (regions.indexOf(value.value) > -1) {value.checked = true} else {value.checked = false}})
      
          // stop accidental advance when spacebar
          $('input').blur()

        }

        function pause() {
          global_timer.stop()
          d3.selectAll("circle").transition()
        }

        function restart()  {
          regenerate()
        }

        function regenerate() {

            // TODO: there was a bug while going from year 0 to year N if the process is interrupted
            year_0 = $("#year_0").val()
            year_N = $("#year_N").val()

            // regions = []
            // $("input[type=checkbox]:checked").each( function(key,value) {if (value.defaultValue){regions.push(value.defaultValue)}})

            d3.selectAll("svg").remove()
            data_series = generateData(gapminder,mapping)
            showData(data_series)
        }

        $("#year_0").on("change",regenerate)
        $("#year_N").on("change",regenerate)

        $("#controls > select").on("change",update_mapping)
        $("input[type=checkbox]").on("change",regenerate)

        d3.select("body").on("keypress", function() {
            if(d3.event.keyCode === 13){
              if (global_timer._time != "Infinity"){
                pause();
              }
              else {
                regenerate()
              }
            }
          });


        hide("end")
        hide("overlay")

        data_series = generateData(gapminder,mapping)
        showData(data_series)
        var trial_i = 0;

        answers = []

        function add_answer() {

            answer = {}
            answer["text"] = $("textarea").val()
            answer["ranks"] = [$("#select-domininant-x").val(), $("#select-domininant-s").val(), $("#select-domininant-l").val() ]
            answer["closest"] = highlighted
            answers.push(answer)

        }

        $("#submit_answer").on("click", function () {
          trial_i += 1
          if (trial_i < 6) {
            add_answer()
            advance(trial_i)
          }

          else if (trial_i == 6){
            add_answer()
            show("end")
            pause()
            localStorage["answers"] = JSON.stringify(answers)
          }
        });

        var question = ""
        question_i = 0 
        $("#toggle_q").on("click", function () {
                  question_vars = ["q1","q2","q3"];
                  
                  for (i=0;i<3;i++) {
                    if ((question_i % 3) == i) {
                      $("#" + question_vars[i]).attr("style","display:block")
                    }
                    else {
                      $("#" + question_vars[i]).attr("style","display:none") 
                    }
                  }

                  question_i += 1;

                });

        var paused = ""
        paused_i = 0 
        $("#toggle_p").on("click", function () {
                  paused_vars = ["","position","fill","r"]
                  paused_i += 1
                  paused = paused_vars[paused_i % 4]
                });



        advance(0)


  </script>


  </body>
</html>
